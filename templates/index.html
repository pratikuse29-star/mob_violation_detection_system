<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Modular Detection System | PhD Module</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-layer-group me-2"></i>MODULAR DETECT
            </a>
            <span class="navbar-text text-light">PhD Presentation Mode</span>
        </div>
    </nav>

    <div class="container py-5">

        <!-- Upload Mode -->
        {% if not mode %}
        <div class="row justify-content-center align-items-center" style="min-height: 70vh;">
            <div class="col-lg-8 text-center">
                <h1 class="display-4 mb-4 fw-bold">Select Detection Module</h1>
                <p class="lead text-muted mb-4">Choose a specific detection module to analyze the video.</p>

                <div class="card bg-dark border-secondary mb-5 mx-auto" style="max-width: 500px;">
                    <div class="card-body">
                        <label class="form-label text-info fw-bold">Active Module:</label>
                        <select id="moduleSelect"
                            class="form-select form-select-lg bg-black text-light border-info mb-3">
                            <option value="all" selected>üîç All Modules (Full System)</option>
                            <option value="person">üë§ Person Detection Only</option>
                            <option value="weapon">üî´ Weapon Detection Only</option>
                            <option value="fire">üî• Fire Detection Only</option>
                            <option value="stick">üèè Stick Detection Only</option>
                            <option value="placard">ü™ß Placard Detection Only</option>
                        </select>
                    </div>
                </div>

                <div class="upload-zone" id="dropZone">
                    <i class="fas fa-microchip upload-icon"></i>
                    <h3>Drop Video to Process</h3>
                    <p class="text-muted">Selected module will be applied</p>
                    <input type="file" id="fileInput" accept="video/*" style="display: none;">
                </div>

                <div id="uploadProgress" class="mt-4" style="display: none;">
                    <div class="progress" style="height: 5px; background: #222;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-info mt-2">Uploading & Initializing Module...</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Processing/Live Mode -->
        <div id="processingView" style="display: none;">
            <div class="row mb-4">
                <div class="col-12 d-flex justify-content-between align-items-center">
                    <h2 class="text-primary"><i class="fas fa-cogs me-2"></i>Module Processing</h2>
                    <span class="badge bg-warning animate-pulse" id="activeModuleBadge">MODULE ACTIVE</span>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-9">
                    <div class="video-wrapper">
                        <div class="scanner"></div>
                        <div class="live-badge">LIVE</div>
                        <img id="liveFeed" src="" class="w-100" style="display: block;">
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card bg-dark border-0 h-100">
                        <div class="card-body">
                            <h5 class="card-title text-muted mb-4">MODULE STATUS</h5>
                            <div class="d-flex align-items-center mb-3">
                                <div class="spinner-border text-primary spinner-border-sm me-2" role="status"></div>
                                <span class="text-primary">Inference Running...</span>
                            </div>
                            <hr class="border-secondary">
                            <p class="small text-muted">Filtering for selected class only.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Result Mode -->
        {% if mode == 'result' %}
        <div class="row animate-fade-in">
            <div class="col-12 mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h2><i class="fas fa-file-alt me-2"></i>Module Report: {{ module|upper }}</h2>
                    <a href="/" class="btn btn-cyber">Select New Module</a>
                </div>
            </div>

            <!-- Video Player -->
            <div class="col-lg-8 mb-4">
                <div class="video-wrapper">
                    <video id="resultVideo" controls class="w-100">
                        <source src="{{ url_for('static_proxy', p='results/'+annotated_video) }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="col-lg-4">
                <div class="row g-3">
                    {% if module == 'all' or module == 'person' %}
                    <div class="col-12">
                        <div class="stat-card text-center">
                            <div class="stat-label">People Detected</div>
                            <div class="stat-value text-success">{{ counts.person }}</div>
                        </div>
                    </div>
                    {% endif %}

                    {% if module == 'all' or module == 'weapon' %}
                    <div class="col-12">
                        <div class="stat-card text-center">
                            <div class="stat-label">Weapons Detected</div>
                            <div class="stat-value text-danger">{{ counts.weapon }}</div>
                        </div>
                    </div>
                    {% endif %}

                    {% if module == 'all' or module == 'fire' %}
                    <div class="col-12">
                        <div class="stat-card text-center">
                            <div class="stat-label">Fire Incidents</div>
                            <div class="stat-value text-warning">{{ counts.fire }}</div>
                        </div>
                    </div>
                    {% endif %}

                    {% if module == 'all' or module == 'stick' %}
                    <div class="col-12">
                        <div class="stat-card text-center">
                            <div class="stat-label">Sticks Detected</div>
                            <div class="stat-value text-info">{{ counts.stick }}</div>
                        </div>
                    </div>
                    {% endif %}

                    {% if module == 'all' or module == 'placard' %}
                    <div class="col-12">
                        <div class="stat-card text-center">
                            <div class="stat-label">Placards Detected</div>
                            <div class="stat-value text-warning">{{ counts.placard }}</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Upload Logic
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const moduleSelect = document.getElementById('moduleSelect');

        if (dropZone) {
            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    handleUpload(e.dataTransfer.files[0]);
                }
            });

            fileInput.addEventListener('change', () => {
                if (fileInput.files.length) {
                    handleUpload(fileInput.files[0]);
                }
            });
        }

        function handleUpload(file) {
            const formData = new FormData();
            formData.append('video', file);
            formData.append('module', moduleSelect.value);

            document.getElementById('uploadProgress').style.display = 'block';

            // Simulating upload progress
            let progress = 0;
            const progressBar = document.querySelector('.progress-bar');
            const interval = setInterval(() => {
                progress += 5;
                if (progress > 90) clearInterval(interval);
                progressBar.style.width = progress + '%';
            }, 100);

            fetch('/', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    clearInterval(interval);
                    progressBar.style.width = '100%';
                    startProcessing(data.uid, data.module);
                })
                .catch(error => console.error('Error:', error));
        }

        function startProcessing(uid, module) {
            // Hide upload, show processing
            if (document.querySelector('.row.justify-content-center'))
                document.querySelector('.row.justify-content-center').style.display = 'none';
            document.getElementById('processingView').style.display = 'block';
            document.getElementById('activeModuleBadge').textContent = `MODULE: ${module.toUpperCase()}`;

            // Set live feed source
            const liveFeed = document.getElementById('liveFeed');
            liveFeed.src = `/video_feed/${uid}`;

            // Poll status
            const statusInterval = setInterval(() => {
                fetch(`/status/${uid}`)
                    .then(res => res.json())
                    .then(status => {
                        if (status.status === 'completed') {
                            clearInterval(statusInterval);
                            window.location.href = `/result/${uid}`;
                        }
                    });
            }, 1000);
        }
    </script>
</body>

</html>